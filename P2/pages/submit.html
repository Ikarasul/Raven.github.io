<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô - Raven.Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/theme.js"></script>
    <script src="../js/nav.js"></script>
    <!-- üéÑ Christmas Theme -->
    <link rel="stylesheet" href="../css/christmas-theme.css">
    <script src="../js/christmas-effects.js" defer></script>

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Prompt', 'Outfit', sans-serif;
            color: #334155;
            min-height: 100vh;
            overflow-x: hidden;
            /* Prevent iOS zoom on inputs */
            text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
        }

        /* Abstract Background */
        .bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(at 100% 0%, rgba(236, 253, 245, 1) 0%, transparent 60%),
                radial-gradient(at 0% 100%, rgba(240, 249, 255, 1) 0%, transparent 60%);
        }

        /* HERO INPUT BAR */
        .input-bar-container {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            /* Softer shadow */
            border: 1px solid rgba(0, 0, 0, 0.02);
            padding: 0.5rem;
            /* Mobile First: Compact padding */
            display: flex;
            gap: 0.5rem;
            /* Compact gap */
            position: relative;
            z-index: 20;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .input-bar-container {
                padding: 0.75rem;
                gap: 0.75rem;
                box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08);
            }
        }

        .input-bar-container:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .course-select {
            background: #f1f5f9;
            border-radius: 1rem;
            padding: 0 0.75rem;
            /* Compact */
            font-weight: 600;
            font-size: 0.9rem;
            color: #475569;
            border: none;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7' /%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            /* Tighter arrow */
            background-size: 0.8rem;
            padding-right: 1.75rem;
            /* Space for arrow */
            max-width: 110px;
            /* Limit width on mobile */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .course-select {
                padding: 0 1rem;
                padding-right: 2.5rem;
                background-position: right 0.75rem center;
                background-size: 1rem;
                max-width: none;
            }
        }

        .course-select:hover {
            background-color: #e2e8f0;
        }

        .main-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            /* Prevent Zoom (16px) */
            font-weight: 500;
            padding: 0.5rem;
            color: #334155;
            min-width: 0;
        }

        @media (min-width: 768px) {
            .main-input {
                font-size: 1.1rem;
                padding: 0.75rem;
            }
        }

        .main-input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }

        .btn-add {
            background: #0f172a;
            color: white;
            border-radius: 1rem;
            padding: 0 1rem;
            /* Compact */
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 44px;
            /* Tappable area */
        }

        @media (min-width: 768px) {
            .btn-add {
                padding: 0 1.5rem;
            }
        }

        .btn-add:hover {
            background: #1e293b;
            transform: scale(1.05);
        }

        /* Task List */
        .task-card {
            background: white;
            border-radius: 1rem;
            /* Slightly smaller radius mobile */
            padding: 1rem;
            /* Reduced padding mobile */
            margin-bottom: 0.75rem;
            /* Tighter spacing */
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: all 0.2s;
        }

        @media (min-width: 768px) {
            .task-card {
                border-radius: 1.25rem;
                padding: 1.25rem;
                margin-bottom: 1rem;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
            }
        }

        .task-card:hover {
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
            transform: translateX(2px);
        }

        .drop-pill {
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
            height: 44px;
            /* Tappable */
        }

        @media (min-width: 768px) {
            .drop-pill {
                width: auto;
                height: auto;
            }
        }

        .drop-pill:hover,
        .drop-pill.dragover {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
        }

        .drop-pill.filled {
            background: #ecfdf5;
            border-color: #10b981;
            border-style: solid;
            color: #059669;
        }

        .strikethrough {
            text-decoration: line-through;
            opacity: 0.5;
        }
    </style>
</head>

<body class="selection:bg-emerald-100 selection:text-emerald-900">
    <div class="bg-mesh"></div>

    <div class="max-w-3xl mx-auto px-4 pt-24 pb-32 animate-enter"> <!-- Mobile Optimized Padding -->

        <!-- HEADER -->
        <div class="flex items-end justify-between mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800" data-i18n="submit_title">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô üì§</h1>
                <p class="text-slate-500 font-medium mt-1 text-sm md:text-base">
                    <span id="pending-count" class="text-emerald-600 font-bold">0</span> Pending Tasks
                </p>
            </div>
            <button onclick="openSettings()"
                class="text-xs font-bold text-slate-300 hover:text-slate-500 flex items-center gap-1 transition-colors settings-btn px-2 py-1 -mr-2">
                <i data-lucide="settings-2" width="14"></i> Config
            </button>
        </div>

        <!-- HERO INPUT (FAST ADD) -->
        <div class="input-bar-container mb-12">
            <select id="new-course-id" class="course-select">
                <!-- JS Populated -->
            </select>
            <input type="text" id="new-task-title" class="main-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                onkeydown="checkEnter(event)">
            <button onclick="addTask()" class="btn-add">
                <i data-lucide="plus" width="20"></i> <span class="hidden md:inline">Add</span>
            </button>
        </div>

        <!-- LISTS -->
        <div id="todo-container" class="space-y-4 min-h-[100px]">
            <!-- JS -->
        </div>

        <div class="mt-12 opacity-60">
            <h3 class="font-bold text-sm text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-200 pb-2"
                data-i18n="submit_completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</h3>
            <div id="done-container" class="space-y-4">
                <!-- JS -->
            </div>
        </div>

        <!-- EMPTY STATE -->
        <div id="empty-state" class="hidden text-center py-10 opacity-70">
            <p class="text-slate-400" data-i18n="submit_empty">‡πÄ‡∏¢‡πâ! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß üéâ</p>
        </div>

    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-xl transform -translate-y-20 opacity-0 transition-all duration-300 z-[100] flex items-center gap-3">
        <i data-lucide="check" width="18" class="text-emerald-400"></i>
        <span id="toast-msg" class="font-medium text-sm">Action Complete</span>
    </div>

    <!-- Chatbot -->
    <div id="chatbot-container"></div>
    <script src="../js/chatbot.js"></script>

    <script>
        // CONFIG
        const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbxn5G_6k6prvYEzsFZz9fzVMqoExOeywMtO9xghKupZe5eqqth8QiJgicQj19gjSyu8/exec";
        const GAS_KEY = 'raven_gas_url';

        let assignments = [];

        // ROBUST COURSES
        function getCourses() {
            if (window.COURSES && window.COURSES.length > 0) return window.COURSES;
            return [
                { id: 'ICT12367', name: 'Web App Security', color: 'emerald', icon: 'shield' },
                { id: 'ICT22667', name: 'Data Management', color: 'orange', icon: 'database' },
                { id: 'ICT24267', name: 'Cloud Computing', color: 'blue', icon: 'cloud' },
                { id: 'ICT25267', name: 'IS Standards', color: 'purple', icon: 'lock' },
                { id: 'ICT25367', name: 'IT Audit', color: 'pink', icon: 'file-search' },
                { id: 'GEN', name: 'General', color: 'slate', icon: 'file' }
            ];
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Init Data
            assignments = JSON.parse(localStorage.getItem('raven_assignments') || '[]');
            if (!localStorage.getItem(GAS_KEY)) localStorage.setItem(GAS_KEY, DEFAULT_GAS_URL);

            // Migration
            if (!localStorage.getItem('raven_assignments') && localStorage.getItem('raven_tasks')) {
                const t = JSON.parse(localStorage.getItem('raven_tasks') || '[]');
                const c = getCourses();
                t.forEach(task => assignments.push({ id: crypto.randomUUID(), courseId: c[0].id, title: task.text, done: task.done, file: null }));
                save();
            }

            populateCourseSelect();
            render();
            lucide.createIcons();
        });

        // --- View ---
        function populateCourseSelect() {
            const sel = document.getElementById('new-course-id');
            sel.innerHTML = '';
            getCourses().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.innerText = c.name;
                sel.appendChild(opt);
            });
        }

        function render() {
            const todoEl = document.getElementById('todo-container');
            const doneEl = document.getElementById('done-container');

            todoEl.innerHTML = ''; doneEl.innerHTML = '';

            const todoItems = assignments.filter(a => !a.done && !a.file);
            const doneItems = assignments.filter(a => a.done || a.file);

            document.getElementById('pending-count').innerText = todoItems.length;

            if (assignments.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');

            const courses = getCourses();

            const createCard = (a, isDone) => {
                const c = courses.find(x => x.id === a.courseId) || courses[0];
                const card = document.createElement('div');
                card.className = 'task-card group';

                // Drag
                card.ondragover = (e) => { e.preventDefault(); card.querySelector('.drop-pill').classList.add('dragover'); };
                card.ondragleave = (e) => { card.querySelector('.drop-pill').classList.remove('dragover'); };
                card.ondrop = (e) => { handleDrop(e, a.id); };

                card.innerHTML = `
                    <div class="w-12 h-12 rounded-xl bg-${c.color}-100 text-${c.color}-600 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="${c.icon || 'file'}" width="20"></i>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h4 class="font-bold text-slate-800 text-lg truncate ${isDone ? 'strikethrough text-slate-400' : ''}">${a.title}</h4>
                            <span class="text-[10px] font-bold uppercase bg-slate-50 text-slate-400 px-1.5 py-0.5 rounded border border-slate-100">${c.name}</span>
                        </div>
                        <div class="text-xs font-medium text-slate-400 truncate">
                            ${a.file ? `<span class="text-emerald-500 flex items-center gap-1"><i data-lucide="file-check" width="12"></i> ${a.file}</span>` : '‡∏£‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô...'}
                        </div>
                    </div>

                    <div class="flex items-center gap-2 w-full md:w-auto mt-2 md:mt-0">
                        <label class="drop-pill flex-1 md:flex-none ${a.file ? 'filled' : ''}">
                             ${a.file ?
                        `<i data-lucide="check" width="14"></i> <span>Done</span>` :
                        `<i data-lucide="upload-cloud" width="14"></i> <span data-i18n="submit_drag">Drop File</span>`
                    }
                             <input type="file" class="hidden" onchange="handleFileSelect(event, '${a.id}')">
                        </label>
                        
                        <button onclick="toggleDone('${a.id}')" class="w-10 h-10 rounded-xl border border-slate-200 flex items-center justify-center hover:bg-slate-50 text-slate-300 hover:text-emerald-500 transition-colors">
                            <i data-lucide="${isDone ? 'rotate-ccw' : 'check'}" width="18"></i>
                        </button>
                        
                        <button onclick="deleteAssign('${a.id}')" class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-red-50 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                             <i data-lucide="trash-2" width="18"></i>
                        </button>
                    </div>
                `;
                return card;
            };

            todoItems.forEach(i => todoEl.appendChild(createCard(i, false)));
            doneItems.forEach(i => doneEl.appendChild(createCard(i, true)));

            if (window.updatePageContent) window.updatePageContent();
            lucide.createIcons();
        }

        // --- Actions ---

        function save() { localStorage.setItem('raven_assignments', JSON.stringify(assignments)); render(); }

        window.addTask = () => {
            const titleInput = document.getElementById('new-task-title');
            const courseSelect = document.getElementById('new-course-id');
            const t = titleInput.value.trim();

            if (!t) { showToast('‚ö†Ô∏è Please enter assignment title'); return; }

            assignments.unshift({
                id: crypto.randomUUID(),
                courseId: courseSelect.value,
                title: t,
                done: false,
                file: null
            });

            titleInput.value = ''; // Reset
            save();
            showToast('‚úÖ Activity Added!');
        };

        window.checkEnter = (e) => { if (e.key === 'Enter') addTask(); };

        window.toggleDone = (id) => {
            const i = assignments.findIndex(x => x.id === id);
            if (i > -1) { assignments[i].done = !assignments[i].done; save(); }
        }

        window.deleteAssign = (id) => {
            if (confirm('Delete?')) { assignments = assignments.filter(x => x.id !== id); save(); }
        }

        // --- Files ---
        window.handleFileSelect = (e, id) => { if (e.target.files[0]) processFile(e.target.files[0], id); }
        window.handleDrop = (e, id) => { e.preventDefault(); if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0], id); }

        async function processFile(file, id) {
            const i = assignments.findIndex(x => x.id === id);
            if (i < 0) return;

            const a = assignments[i];
            const c = getCourses().find(x => x.id === a.courseId) || getCourses()[0];
            const newName = `${c.name} - ${a.title}.${file.name.split('.').pop()}`;

            a.file = newName; a.done = true; save();
            showToast(`Uploading: ${newName}`);

            const url = localStorage.getItem(GAS_KEY) || DEFAULT_GAS_URL;
            if (url && url.includes('script.google')) {
                try {
                    const b64 = await toBase64(file);
                    await fetch(url, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ file: b64.split(',')[1], filename: newName, mimeType: file.type, folderName: c.id })
                    });
                    showToast("Uploaded to Drive! ‚òÅÔ∏è");
                } catch (e) { showToast("Saved Locally"); dl(file, newName); }
            } else {
                showToast("Saved Locally"); dl(file, newName);
            }
        }

        window.openSettings = () => {
            const u = prompt("Google Script URL:", localStorage.getItem(GAS_KEY) || DEFAULT_GAS_URL);
            if (u !== null) localStorage.setItem(GAS_KEY, u.trim() || DEFAULT_GAS_URL);
        }

        const dl = (f, n) => { const a = document.createElement('a'); a.href = URL.createObjectURL(f); a.download = n; document.body.appendChild(a); a.click(); a.remove(); };
        const toBase64 = f => new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(f); r.onload = () => res(r.result); r.onerror = rej; });
        function showToast(m) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; t.classList.remove('opacity-0', '-translate-y-20'); setTimeout(() => t.classList.add('opacity-0', '-translate-y-20'), 3000); }

    </script>
</body>

</html>